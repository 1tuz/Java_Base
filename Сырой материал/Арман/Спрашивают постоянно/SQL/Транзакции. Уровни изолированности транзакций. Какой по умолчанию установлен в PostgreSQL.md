**Транзакция** — это группа операций с базой данных, которые выполняются как одно целое. Либо все операции транзакции выполняются успешно, либо ни одна из них не выполняется.

Под капотом транзакция работает следующим образом: Транзакция реализует паттерн Proxy. **Proxy** в транзакциях используется для управления доступом и поведением объектов, связанных с транзакцией. Когда мы используем ORM-фреймворки (например, Hibernate или Spring Data JPA), транзакция используют паттерн **Proxy**, чтобы отложить выполнение запроса или работу с транзакцией до тех пор, пока это действительно необходимо. Вместо немедленного выполнения запроса при вызове метода, фреймворк создаёт _Proxy-объект_. Реальное соединение и операции с базой данных происходят только при первом обращении. Только при реальном обращении к данным через метод, паттерн Proxy инициирует транзакцию и выполняет запрос.

Основные принципы работы транзакции:
1. Начало транзакции: Java отправляет команду базе данных, чтобы начать транзакцию. В JDBC это делается с помощью метода: connection.setAutoCommit(false);
2. Выполнение операций: Java выполняет серию SQL-запросов через `Statement` или `PreparedStatement`.
3. Подтверждение транзакции (Commit): Если все операции прошли успешно, Java отправляет сигнал `commit`, чтобы подтвердить изменения в базе данных. connection.commit();
4. Откат транзакции (Rollback): Если произошла ошибка, Java отправляет сигнал `rollback`, и все изменения отменяются. connection.rollback();
5. Завершение транзакции: В любом случае, после работы с транзакцией, соединение с базой данных закрывается.

Почему транзакции стоит использовать:
	1. Lazy Loading (ленивая загрузка): Объект или данные загружаются только по мере необходимости.
	2. Контроль транзакций: Proxy автоматически начинает и завершает транзакцию в момент первого обращения.
	3. Изоляция и оптимизация: Позволяет минимизировать операции с БД, так как запросы не выполняются сразу.

Уровни изоляции:
1. Read Uncommitted - Позволяет читать данные, которые другие транзакции еще не подтвердили.
2. Read Committed - Можно читать только те данные, которые были подтверждены другими транзакциями.
3. Repeatable Read - Данные не изменяются между двумя чтениями в рамках одной транзакции.
4. Serializable - Самый высокий уровень изоляции. Транзакции работают последовательно.

Аномалии в транзакциях бывают:
1. **«грязное» чтение** — чтение данных, добавленных или измененных транзакцией, которая впоследствии не откатится;
2. **неповторяющееся чтение** — в рамках одной транзакции один и тот же запрос данных дает разные результаты, что происходит из-за изменения или удаления данных другой (параллельной) транзакцией.
3. **фантомное чтение** — в рамках одной транзакции один и тот же запрос данных дает разные результаты, что происходит из-за добавления данных другой (параллельной) транзакцией.

![[Pasted image 20241208221436.png]]

В **PostgreSQL** по умолчанию установлен уровень изолированности **`Read Committed`**.

Почему выбран `Read Committed`?
Это сбалансированный уровень изолированности, который обеспечивает хороший баланс между консистентностью данных и производительностью, избегая избыточного блокирования.
