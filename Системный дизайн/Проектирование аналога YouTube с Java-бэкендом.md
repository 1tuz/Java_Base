Данный документ описывает архитектуру системы для создания аналога YouTube с использованием Java-бэкенда. Архитектура разработана с учетом требований к высокой масштабируемости, доступности и производительности.

Предполагаемый масштаб:

- 5+ миллионов DAU (ежедневных активных пользователей)
- 100,000+ загрузок видео в день
- 5+ миллионов просмотров видео в день
- Средний размер видео: 200 МБ
- Хранение данных за несколько лет

Основные функциональные возможности:

- Загрузка и обработка видео
- Потоковая передача видео пользователям
- Поиск и рекомендации контента
- Взаимодействие пользователей (комментарии, лайки, подписки)
- Монетизация контента
- Аналитика и мониторинг
## Базовая схема сервиса

```
┌─────────────┐       ┌───────────────────┐       ┌──────────────────┐
│  Клиенты    │──────▶│  Балансировщик    │──────▶│  API Gateway     │
│  (Браузер/  │       │  нагрузки         │       │                  │
│  Моб. прил.)│◀──────│                   │◀──────│                  │
└─────────────┘       └───────────────────┘       └────────┬─────────┘
                                                           │
                                                           ▼
┌──────────────────────────────────────────────────────────────────────┐
│                           Микросервисы (Java)                        │
│                                                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │ Сервис      │  │ Сервис      │  │ Сервис      │  │ Сервис      │  │
│  │ аутенти-    │  │ метаданных  │  │ загрузки    │  │ поиска      │  │
│  │ фикации     │  │ видео       │  │ видео       │  │             │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │
│                                                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │ Сервис      │  │ Сервис      │  │ Сервис      │  │ Сервис      │  │
│  │ обработки   │  │ комментариев│  │ уведомлений │  │ рекомендаций│  │
│  │ видео       │  │             │  │             │  │             │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
                         │                 │
                         ▼                 ▼
┌─────────────────┐    ┌─────────────-┐    ┌─────────────┐    ┌─────────────┐
│ Очереди         │    │ БД метаданных│    │ Объектное   │    │ CDN         │
│ сообщений       │    │ (SQL/NoSQL)  │    │ хранилище   │    │             │
│ (Kafka/RabbitMQ)│    │              │    │ (видео)     │    │             │
└─────────────────┘    └─────────────-┘    └─────────────┘    └─────────────┘
```

## Схемы пользовательских потоков

### 1. Поток загрузки видео
![[Pasted image 20250413122936.png]]
### 2. Поток просмотра видео

```
┌─────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ Клиент      │    │ API Gateway   │    │ Сервис        │    │ БД метаданных │
│             │───▶│               │───▶│ метаданных    │───▶│               │
└─────┬───────┘    └───────────────┘    └───────┬───────┘    └───────────────┘
      │                                          │
      │                                          ▼
      │                                  ┌───────────────┐    ┌───────────────┐
      │                                  │ Кэш           │───▶│ Сервис        │
      │                                  │ метаданных    │    │ аналитики     │
      │                                  └───────┬───────┘    └───────────────┘
      │                                          │
      │                                          ▼
      │                                  ┌───────────────┐
      │                                  │ Сервис        │
      │                                  │ рекомендаций  │
      │                                  └───────┬───────┘
      │                                          │
      ▼                                          ▼
┌─────────────┐    ┌───────────────┐    ┌───────────────┐
│ Клиент      │    │ CDN           │◀───│ Объектное     │
│ (видеоплеер)│◀───│               │    │ хранилище     │
└─────────────┘    └───────────────┘    └───────────────┘
```

### 3. Поток поиска и взаимодействия

```
┌─────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ Клиент      │    │ API Gateway   │    │ Сервис        │    │ Elasticsearch │
│ (поиск)     │───▶│               │───▶│ поиска        │───▶│               │
└─────────────┘    └───────────────┘    └───────┬───────┘    └───────────────┘
                                                 │
                                                 ▼
┌─────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ Клиент      │    │ API Gateway   │    │ Сервис        │    │ БД            │
│ (комментарий)────│               │───▶│ комментариев  │───▶│ комментариев  │
└─────────────┘    └───────────────┘    └───────┬───────┘    └───────────────┘
                                                 │
                                                 ▼
┌─────────────┐    ┌───────────────┐    ┌───────────────┐
│ Клиент      │    │ WebSocket     │◀───│ Сервис        │
│ (уведомл.)  │◀───│ сервер        │    │ уведомлений   │
└─────────────┘    └───────────────┘    └───────────────┘
```

## Детальное объяснение ключевых компонентов

### 1. API Gateway и Балансировщик нагрузки

#### API Gateway:

- **Что это**: Единая точка входа для всех клиентских запросов, управляет маршрутизацией к соответствующим микросервисам
- **Технологические варианты**:
    - **Spring Cloud Gateway**: Оптимально для Java-экосистемы, поддерживает предикаты маршрутизации, фильтры
    - **Netflix Zuul**: Проверенное решение, но менее производительное чем Spring Cloud Gateway
    - **Kong**: Высокопроизводительный API Gateway на базе NGINX
- **Ключевые функции**:
    - Аутентификация и авторизация
    - Ограничение трафика (rate limiting)
    - Логирование и мониторинг
    - Трансформация запросов/ответов
    - Кэширование ответов

#### Балансировщик нагрузки:

- **Что это**: Распределяет входящий трафик между несколькими серверами для оптимизации использования ресурсов
- **Типы**:
    - **L4 (транспортный уровень)**: Работает с TCP/UDP, более производительный, но менее "умный"
    - **L7 (прикладной уровень)**: Анализирует HTTP-заголовки, более гибкий, поддерживает маршрутизацию на основе содержимого
- **Технологические варианты**:
    - **HAProxy**: Высокопроизводительный программный балансировщик
    - **NGINX**: Популярный веб-сервер с функциями балансировки
    - **AWS ELB/ALB**: Управляемые сервисы для AWS

### 2. Микросервисная архитектура на Java

#### Технологический стек:

- **Spring Boot** (2.6+): Основа для микросервисов
- **Spring Cloud**: Для интеграции сервисов
    - **Spring Cloud Config**: Централизованная конфигурация
    - **Spring Cloud Netflix (Eureka)**: Обнаружение сервисов
    - **Spring Cloud Circuit Breaker**: Устойчивость к сбоям
- **Spring Security**: Для аутентификации и авторизации
- **Spring Data**: Для взаимодействия с базами данных
- **Project Reactor/WebFlux**: Для реактивного программирования

#### Ключевые сервисы:

- **Сервис аутентификации**:
    
    - OAuth 2.0/OpenID Connect
    - JWT для токенов
    - Интеграция с внешними IdP (Google, Facebook)
- **Сервис загрузки видео**:
    
    - Multipart загрузка с возобновлением
    - Валидация контента
    - Ограничения по размеру и формату
- **Сервис обработки видео**:
    
    - Асинхронная обработка через очередь сообщений
    - Интеграция с FFmpeg для транскодирования
    - Генерация превью и миниатюр
    - Экстракция метаданных (длительность, разрешение)
- **Сервис метаданных**:
    
    - CRUD операции для видео-метаданных
    - Управление тегами, категориями
    - История просмотров
- **Сервис рекомендаций**:
    
    - Алгоритмы ML для персонализированных рекомендаций
    - Анализ поведения пользователей
    - Колаборативная фильтрация
- **Сервис поиска**:
    
    - Полнотекстовый поиск
    - Индексация метаданных
    - Фильтрация результатов
- **Сервис комментариев**:
    
    - Управление комментариями пользователей
    - Модерация контента
    - Вложенные комментарии
- **Сервис уведомлений**:
    
    - Отправка уведомлений пользователям
    - Управление предпочтениями уведомлений
    - Различные каналы доставки (email, push, in-app)

### 3. Хранение данных

#### Реляционная БД (PostgreSQL):

- Для структурированных данных (метаданные, учетные записи пользователей)
- Преимущества: ACID-совместимость, транзакционность
- Технологии доступа: Hibernate/JPA, Spring Data JPA
- Схема базы данных:

```
Users(id, username, email, password_hash, created_at, ...)
Videos(id, title, description, user_id, status, upload_date, ...)
Comments(id, video_id, user_id, content, created_at, ...)
Likes(id, video_id, user_id, created_at)
Subscriptions(id, subscriber_id, creator_id, created_at)
Tags(id, name)
VideoTags(video_id, tag_id)
```

#### NoSQL решения:

- **Cassandra**: Для масштабируемого хранения аналитики просмотров, событий
- **MongoDB**: Для полуструктурированных данных (комментарии, отзывы)
- **Redis**: Для кэширования данных, сессий, ограничения трафика

#### Объектное хранилище:

- **Amazon S3** или **Google Cloud Storage**: Для хранения видеофайлов
- Стратегия многоуровневого хранения:
    - Hot storage: Популярные видео (быстрый доступ)
    - Warm storage: Менее популярные
    - Cold storage: Архивные видео (для снижения затрат)

### 4. Обработка сообщений

#### Kafka:

- Для потоковой обработки событий
- Использование для:
    - Очереди обработки видео
    - Аналитика в реальном времени
    - Синхронизация между сервисами
- Ключевые топики:
    
    ```
    video-upload-eventsvideo-processing-eventsuser-activity-eventsrecommendation-eventsnotification-events
    ```
    

#### RabbitMQ:

- Для традиционных очередей сообщений
- Использование для:
    - Уведомления пользователей
    - Обработка комментариев
    - Задания по индексации контента
- Паттерны обмена:
    - Direct Exchange для адресных сообщений
    - Topic Exchange для категорийных сообщений
    - Fanout Exchange для широковещательных оповещений

### 5. Kubernetes для оркестрации

#### Архитектура Kubernetes:

```
┌─────────────────────────────────────────────────────────┐
│ Kubernetes Cluster                                       │
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ Namespace:  │  │ Namespace:  │  │ Namespace:  │     │
│  │ Frontend    │  │ Backend     │  │ Data        │     │
│  │             │  │             │  │             │     │
│  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │     │
│  │ │Frontend │ │  │ │API      │ │  │ │Database │ │     │
│  │ │Pods     │ │  │ │Pods     │ │  │ │Pods     │ │     │
│  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │     │
│  │             │  │             │  │             │     │
│  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │     │
│  │ │Ingress  │ │  │ │Service  │ │  │ │StatefulSet│     │
│  │ │         │ │  │ │Mesh     │ │  │ │         │ │     │
│  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### Преимущества Kubernetes для YouTube-аналога:

- **Автомасштабирование**: Горизонтальное масштабирование под нагрузкой
- **Самовосстановление**: Автоматическая перезагрузка неисправных контейнеров
- **Управление конфигурацией**: ConfigMaps и Secrets для конфигурации
- **Плавное обновление**: Rolling updates и канареечные развертывания
- **Эффективное использование ресурсов**: Оптимальное размещение контейнеров

#### Рекомендуемые компоненты:

- **Istio**: Service Mesh для управления трафиком и безопасностью
- **Prometheus + Grafana**: Мониторинг и визуализация
- **EFK (Elasticsearch, Fluentd, Kibana)**: Для централизованного логирования
- **Helm**: Для упаковки и развертывания приложений

## Стратегии масштабирования

### 1. Горизонтальное масштабирование:

- **Микросервисы**: Независимое масштабирование каждого сервиса
- **Stateless дизайн**: Сервисы без состояния для простоты масштабирования
- **Шардирование данных**: Распределение данных по разным базам данных

### 2. Оптимизация CDN и доставки контента:

- **Мульти-CDN стратегия**: Использование нескольких CDN-провайдеров
- **Динамический выбор CDN**: На основе географии пользователя, доступности
- **Edge Computing**: Размещение логики на краевых серверах для снижения латентности

### 3. Географическое распределение:

- **Мульти-регион развертывание**: Размещение сервисов в разных регионах
- **Геомаршрутизация**: Направление пользователей к ближайшим центрам обработки данных
- **Репликация данных**: Синхронизация данных между регионами

### 4. Оптимизация обработки видео:

- **Параллельная обработка**: Разделение видео на сегменты для одновременной обработки
- **Приоритезация задач**: Обработка видео по приоритету (популярные каналы быстрее)
- **Предварительный анализ**: Определение оптимальных параметров транскодирования

### 5. Эволюция архитектуры:

- **Переход от монолита к микросервисам**: Постепенное разделение функциональности
- **Событийно-ориентированная архитектура**: Улучшение слабой связанности компонентов
- **CQRS (Command Query Responsibility Segregation)**: Разделение операций чтения и записи

## Безопасность и соответствие нормативам

### 1. Безопасность системы:

- **Аутентификация и авторизация**:
    
    - OAuth 2.0 / OpenID Connect для внешней авторизации
    - JWT для передачи токенов аутентификации
    - Детальная авторизация на уровне ресурсов (ACL)
- **Защита API**:
    
    - Ограничение частоты запросов (Rate limiting)
    - Защита от CSRF, XSS атак
    - Контроль доступа на основе ролей (RBAC)
- **Защита данных**:
    
    - Шифрование данных в покое
    - Шифрование данных при передаче (TLS/SSL)
    - Управление секретами с использованием Vault

### 2. Соответствие нормативам:

- **GDPR/CCPA**:
    
    - Возможность экспорта пользовательских данных
    - Возможность удаления всех данных пользователя
    - Прозрачная политика конфиденциальности
- **Защита прав интеллектуальной собственности**:
    
    - Система обнаружения нарушений авторских прав
    - Механизм оспаривания претензий
    - Фильтрация контента по геолокации согласно местным законам

### 3. Мониторинг безопасности:

- **Логирование событий безопасности**:
    
    - Централизованная система логирования
    - Система обнаружения вторжений
    - Мониторинг аномального поведения
- **Аудит доступа**:
    
    - Отслеживание изменений конфигурации
    - Аудит доступа к данным
    - Регулярные проверки уязвимостей
